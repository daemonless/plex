#!/bin/sh
# Plex Media Server configuration initialization

echo "[plex] Setting up Plex Media Server"

# Create Application Support directory structure
mkdir -p "/config/Library/Application Support/Plex Media Server"
mkdir -p /transcode

# Handle PLEX_CLAIM token for initial setup (from plex.tv/claim)
if [ -n "$PLEX_CLAIM" ]; then
    PREF_FILE="/config/Library/Application Support/Plex Media Server/Preferences.xml"
    if [ ! -f "$PREF_FILE" ]; then
        echo "[plex] Configuring claim token for initial setup..."
        cat > "$PREF_FILE" << EOF
<?xml version="1.0" encoding="utf-8"?>
<Preferences AcceptedEULA="1" PublishServerOnPlexOnlineKey="1" PlexOnlineToken="$PLEX_CLAIM"/>
EOF
        echo "[plex] Claim token configured"
    else
        echo "[plex] Preferences.xml exists, skipping claim token"
    fi
fi

# Ensure correct ownership
chown -R bsd:bsd /config /transcode /usr/local/share/plexmediaserver

echo "[plex] Configuration complete"
